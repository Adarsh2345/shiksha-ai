rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    match /classrooms/{classroomId}/files/{fileName} {
      // Read access is handled by download URLs in the app, 
      // but this rule allows authenticated users to read directly via SDK if needed.
      allow read: if request.auth != null;

      // Allow write access only to teachers who are members of the classroom.
      // This rule first checks if the user is a teacher and if the classroomIds field exists
      // before checking for membership, preventing errors for new teachers.
      allow write: if request.auth != null &&
                      get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data.role == 'teacher' &&
                      'classroomIds' in get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data &&
                      classroomId in get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data.classroomIds;
    }
  }
}
